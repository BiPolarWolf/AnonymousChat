# WebSocket в проекте

## Backend (FastAPI)

### @app.websocket("/ws/{room}")
**Что делает:** Создает WebSocket эндпоинт для подключения к комнате  
**Вход:**
- `websocket` (WebSocket) - объект соединения
- `room` (str) - название комнаты из URL

### websocket.accept()
**Что делает:** Принимает WebSocket соединение  
**Вход:** нет

### websocket.receive_json()
**Что делает:** Получает JSON сообщение от клиента  
**Вход:** нет  
**Выход:** dict с данными сообщения

### websocket.send_json()
**Что делает:** Отправляет JSON сообщение клиенту  
**Вход:**
- `data` (dict) - данные для отправки

### WebSocketDisconnect
**Что делает:** Исключение, которое выбрасывается при отключении клиента  
**Использование:** обрабатывается в try/except для очистки соединения

---

## Frontend (Vue + JavaScript)

### new WebSocket(url)
**Что делает:** Создает WebSocket соединение  
**Вход:**
- `url` (string) - адрес WebSocket сервера, например "ws://localhost:8000/ws/general"  
**Выход:** объект WebSocket

### socket.onmessage
**Что делает:** Обработчик входящих сообщений  
**Вход:**
- `event` - объект события с полем `data` (JSON строка)

### socket.send()
**Что делает:** Отправляет данные на сервер  
**Вход:**
- `data` (string) - данные для отправки (обычно JSON.stringify())

### socket.close()
**Что делает:** Закрывает WebSocket соединение  
**Вход:** нет

### socket.onopen
**Что делает:** Обработчик успешного подключения  
**Использование:** вызывается когда соединение установлено

### socket.onerror
**Что делает:** Обработчик ошибок соединения  
**Вход:**
- `event` - объект события с информацией об ошибке

### socket.onclose
**Что делает:** Обработчик закрытия соединения  
**Вход:**
- `event` - объект события с кодом и причиной закрытия

---

## ConnectionManager (наш класс)

### manager.connect()
**Что делает:** Регистрирует новое WebSocket соединение в комнате  
**Вход:**
- `websocket` (WebSocket) - объект соединения
- `room` (str) - название комнаты

### manager.disconnect()
**Что делает:** Удаляет WebSocket соединение из комнаты  
**Вход:**
- `websocket` (WebSocket) - объект соединения
- `room` (str) - название комнаты

### manager.broadcast()
**Что делает:** Отправляет сообщение всем подключенным клиентам в комнате  
**Вход:**
- `message` (dict) - сообщение для отправки
- `room` (str) - название комнаты

### active_connections
**Что делает:** Хранит активные соединения  
**Структура:** `dict[str, list[WebSocket]]` - ключ: название комнаты, значение: список WebSocket соединений

---

## Формат сообщений

### Отправка с клиента
```json
{
  "text": "Текст сообщения",
  "sender": "ИмяПользователя",
  "room": "general"
}
```

### Получение на клиенте
```json
{
  "text": "Текст сообщения",
  "sender": "ИмяПользователя",
  "room": "general",
  "timestamp": 1234567890.123
}
```
